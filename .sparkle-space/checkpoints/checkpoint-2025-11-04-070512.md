# Checkpoint: Milestone 5 Complete - Prompt Expressions

**Sparkler:** Sparkle

**Sparkler:** Sparkle

**Session Summary:** Completed Milestone 5 of the patchwork parser, implementing the language's unique prompt expressions (think/ask/do) that enable AI integration. Built robust parsing for prompt blocks with embedded code, solving lexer/parser token mismatches and making key design simplifications.

**Continuity:** This session continues from completed Milestone 4 (Basic Expressions) where we implemented full expression parsing with manual precedence climbing. The parser now handles both regular code expressions and patchwork's distinctive AI prompt features.

## Key Accomplishments

✅ **AST Extensions** ([ast.rs](crates/patchwork-parser/src/ast.rs:197-220)):
- Added `PromptBlock<'input>` struct with `items: Vec<PromptItem>`
- Added `PromptItem<'input>` enum: Text(&'input str) | Code(Block)
- Extended `Expr` with: Think(PromptBlock), Ask(PromptBlock), Do(Block)

✅ **Grammar Implementation** ([patchwork.lalrpop](crates/patchwork-parser/src/patchwork.lalrpop:500-542)):
- ThinkExpr: `think { PromptBlock }`
- AskExpr: `ask { PromptBlock }`
- DoExpr: `do { StatementList }` (only inside prompts)
- PromptBlock parsing with newline filtering using Option pattern

✅ **Test Coverage** ([lib.rs](crates/patchwork-parser/src/lib.rs:1103-1268)):
- 7 comprehensive prompt expression tests
- Simple think/ask blocks, fallback patterns, embedded do blocks, multiline prompts
- All 44 tests passing, zero parser conflicts

## Important Decisions

**think { } || ask { } is just binary OR**
- David caught that this isn't special syntax - it's the regular || operator!
- Simplified AST: Think(PromptBlock) instead of Think { content, fallback: Option<Expr> }
- Cleaner design, less special-casing

**do { } is not a standalone expression**
- Only valid inside think/ask prompt blocks, not as `var x = do { }`
- DoExpr not included in PrimaryExpr alternatives
- Removed standalone do expression test

**Lexer emits word-level PromptText tokens**
- "Hello world" becomes: PromptText("Hello"), Whitespace, PromptText("world")
- Parser sees multiple consecutive PromptText after whitespace filtering
- Required grammar to allow consecutive prompt_text tokens without newline separators

**Newline filtering pattern**
- PromptItemOrNewline: Option<PromptItem> with prompt items as Some, newlines as None
- Collect with filter_map to cleanly remove formatting newlines
- Avoids lalrpop ambiguity issues with newline* trailing patterns

## Current State

**Files modified:**
- [crates/patchwork-parser/src/ast.rs](crates/patchwork-parser/src/ast.rs) - PromptBlock, PromptItem, Expr variants
- [crates/patchwork-parser/src/patchwork.lalrpop](crates/patchwork-parser/src/patchwork.lalrpop) - Prompt expression rules
- [crates/patchwork-parser/src/lib.rs](crates/patchwork-parser/src/lib.rs) - 7 new prompt tests
- [docs/parser-implementation-plan.md](docs/parser-implementation-plan.md) - Marked M5 complete with notes

**Test status:** 44/44 passing, zero parser conflicts

**Build status:** Clean build across entire project

## Next Steps

Ready for **Milestone 6: String Interpolation**:
- Update StringLiteral to support `${expr}`, `$(cmd)`, and `$id` forms
- Add StringPart enum: Text(&'input str) | Interpolation(Expr)
- Parse chunked string tokens with embedded expressions
- Handle nested interpolation correctly

This is where strings become dynamic!

## Critical Context

- **Prompt text tokenization:** Lexer splits on whitespace - expect multiple PromptText tokens per line
- **Newline handling:** Grammar filters newlines inside prompts using Option<PromptItem> pattern
- **Context-dependent 'do':** Lexer emits Do token only inside prompts; elsewhere it's an identifier
- **Zero-copy maintained:** All new types use lifetime 'input for string slices
- **No standalone do:** Unlike think/ask, do { } cannot be used as a top-level expression

---